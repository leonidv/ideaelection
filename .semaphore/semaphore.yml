version: v1.0
name: Idea Elections
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804

blocks:
  - name: Backend building
    task:
      prologue:
        commands:
          - docker run -d --name db -p 8091-8094:8091-8094 -p 11210:11210 couchbase:community-6.5.0
          - sleep 5
          - checkout
          - cd scripts/
          - ./couchbase-init-test.sh
          - cd ..
          - cache restore m2
          - sem-version java 11
      epilogue:
        commands:
          - cache store m2 $USER_HOME/.m2

      jobs:
        - name: Build backend application
          commands:
            - java -version
            - pwd
            - cd backend
            - ./gradlew -v
            - ./gradlew bootJar
            - nohup java -Dtestmode=on -jar build/libs/backend-*.jar &
            - sleep 10
            - cat nohup.out
            - cd ../backend-test
            - ./gradlew test