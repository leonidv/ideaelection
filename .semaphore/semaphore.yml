version: v1.0
name: Idea Elections
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Backend building
    task:
      prologue:
        commands:
          - 'docker run -d --name db -p 8091-8094:8091-8094 -p 11210:11210 couchbase:community-6.5.0'
          - sleep 5
          - checkout
          - cd scripts/
          - ./couchbase-init-test.sh
          - cd ..
          - cache restore m2
          - cache restore gradleCache
          - sem-version java 11
      epilogue:
        always:
          commands:
            - cache store m2 $USER_HOME/.m2
            - cache store gradleCache $USER_HOME/.gradle/caches/modules-2/files-2.1
        on_fail:
          commands:
            - cd $SEMAPHORE_GIT_DIR
            - cp backend/backend.log backend-test/build/reports
            - tar -zcvf test-reports.tar.gz build/reports
            - artifact push job test-reports.tar.gz
      jobs:
        - name: Build backend application
          commands:
            - java -version
            - pwd
            - cd backend
            - ./gradlew -v
            - ./gradlew bootJar
            добавить сюда указание logback.xml файла
            - nohup java -Dtestmode=on -jar build/libs/backend-*.jar -Dlogging.config=$SEMAPHORE_GIT_DIR/.semaphore/logback.xml &
            - sleep 10
            - cat nohup.out
            - cd ../backend-test
            - ./gradlew test
            - ./gradlew allureReport

