version: v1.0
name: Idea Elections
agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
blocks:
  - name: Backend building
    task:
      env_vars:
        - name:  BUILD_DIR
          value: /home/semaphore/ideaelection
        - name: LOG_DIR
          value:  /home/semaphore/ideaelection/logs
      prologue:
        commands:
          - echo "BUILD_DIR = $BUILD_DIR"
          - checkout
          - echo "from prologue"
          - echo $HOME
          - echo $SEMAPHORE_GIT_DIR
          - echo $HOME/$SEMAPHORE_GIT_DIR
          - cd scripts/
          - ./couchbase-run.sh
          - sleep 5
          - ./couchbase-init-test.sh
          - cd ..
          - cache restore m2
          - cache restore gradleCache
          - sem-version java 11
          - java -version
      epilogue:
        always:
          commands:
            - cache store m2 /home/semaphore/.m2
            - cache store gradleCache /home/semaphore/.gradle/caches/modules-2/files-2.1
        on_fail:
          commands:
            - cp -r $BUILD_DIR/backend-test/build/reports $LOG_DIR
            - tar -zcvf log-and-reports.tar.gz $LOG_DIR
            - artifact push job log-and-reports.tar.gz
      jobs:
        - name: Build backend application
          commands:
            - echo "from commands"
            - echo $HOME
            - echo $SEMAPHORE_GIT_DIR
            - echo $HOME/$SEMAPHORE_GIT_DIR
            - cd backend
            - ./gradlew -v
            - ./gradlew bootJar
            - nohup java -Dtestmode=on -Dlogging.config=$BUILD_DIR/.semaphore/logback.xml -jar build/libs/backend-*.jar &
            - sleep 10
            - cat nohup.out
            - cd ../backend-test
            - ./gradlew test allureReport

