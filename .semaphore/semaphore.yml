version: v1.0
name: Idea Elections

agent:
  machine:
    type: e1-standard-2
    os_image: ubuntu1804
execution_time_limit:
    minutes: 30

global_job_config:
  secrets:
    - name: DockerHubCredentials

  prologue:
    commands:
      - checkout
      - .semaphore/semaphoreci-cleandisk.sh
      - .semaphore/ubuntu1804-podman-install.sh
      - sudo podman info
      - sem-version java 11
      - java -version
      - echo $DOCKERHUB_PASSWORD | sudo podman login --username "$DOCKERHUB_USERNAME" --password-stdin
      - sudo podman login --get-login docker.io

blocks:
  - name: Deploy to test
    task:
      secrets:
        - name: SAEDI_KUBECTL
      jobs:
        - name: Apply deployment
          commands:
            - kubectl config view
            - kubectl get deployments
            - kubectl apply -f  deploy/test-deployment.yaml
            #- kubectl rollout history deployment/saedi-testmode
            #- kubectl rollout status -w depl saedi-testmode

